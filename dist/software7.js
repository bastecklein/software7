var t={d:(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};function n(t,e,n){return t?t.indexOf(e)<0?t:t.replace(new RegExp(function(t){return t.replace(/([.*+?^=!:${}()|[]\/\\])/g,"\\$1")}(e),"g"),n):""}function i(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function o(t,e,n){return"#"+s(t)+s(e)+s(n)}function s(t){let e=t.toString(16);return 1==e.length?"0"+e:e}function a(t){if(Array.isArray(t)){const e=t;t="";for(let n=0;n<e.length;n++)t+=e[n]}let e,n,i=0;if(0===t.length)return i;for(e=0;e<t.length;e++)n=t.charCodeAt(e),i=(i<<5)-i+n,i|=0;return i}t.d(e,{Ay:()=>J,iE:()=>M,Mc:()=>_,XL:()=>P,mU:()=>T});class l{constructor(){this.id=i(),this.frames=[],this.layers=[],this.rulers=[],this.lastSave=(new Date).getTime(),this.created=(new Date).getTime(),this.authors=[],this.firstAuthor=null,this.lastAuthor=null,this.height=0,this.width=0,this.createdApp=null,this.savedApp=null,this.createdAppVer=null,this.savedAppVer=null}}class r{constructor(){this.id=i(),this.mode=null,this.name=null,this.visible=!0,this.opacity=100}}class c{constructor(){this.id=i(),this.layerData={}}}function h(t){const e=new l;if("string"==typeof t)try{t=JSON.parse(t)}catch(t){return console.log(t),e}let n=null;t.data&&(n=t.data);for(let n in e)t[n]&&(e[n]=t[n]);n&&e.layers.push({data:n,mode:null,name:null,visible:!0});const i=[];let o=null;for(let t=0;t<e.layers.length;t++){const n=e.layers[t];if(!n)continue;const s=new r;for(let t in s)n[t]&&(s[t]=n[t]);n.data&&(o||(o={layerData:{}}),o.layerData[s.id]=n.data),i.push(s)}o&&e.frames.push(o),e.layers=i;const s=[];for(let t=0;t<e.frames.length;t++){const n=e.frames[t],i=new c;for(let t in i)n[t]&&(i[t]=n[t]);s.push(i)}if(e.frames=s,0==e.layers.length){const t=new r,n=new c;n.layerData[t.id]=[],e.frames.push(n),e.layers.push(t)}return e}const u=function(t){if(!t.source)return void console.log("No source data!");let e=null,n=1,s=0,a=null,l=null,r=[],c=null,u=null,d=1;t.color&&7==t.color.trim().length&&(l=t.color),t.outlineColor&&(u=t.outlineColor),t.colorReplacements&&(r=t.colorReplacements),null!=t.frame&&null!=t.frame&&(s=t.frame),null!=t.scale&&null!=t.scale&&(n=t.scale),t.callback&&(e=t.callback),t.gridlineImage&&(c=t.gridlineImage),null!=t.opacity&&null!=t.opacity&&(d=t.opacity),a=h(t.source);let f=a.height,g=a.width;if(t.accessories)for(let e=0;e<t.accessories.length;e++){const n=t.accessories[e];if(n.source){const t=n.source;t.width&&t.width>g&&(g=t.width),t.height&&t.height>f&&(f=t.height)}}const m=f*n,p=g*n;let w=p;-1==s&&(w=p*a.frames.length);const y=document.createElement("canvas"),v=y.getContext("2d");y.style.imageRendering="pixelated",v.imageSmoothingEnabled=!1,y.height=m,y.width=w,t.fill&&(v.fillStyle=t.fill,v.fillRect(0,0,w,m));let M=s,x=s+1;-1==s&&(M=0,x=a.frames.length);let R=0;const k=[];if(k.push({source:a,colorReplacements:r}),t.accessories)for(let e=0;e<t.accessories.length;e++){const n=t.accessories[e];k.push(JSON.parse(JSON.stringify(n)))}for(let t=0;t<k.length;t++){R=0;const e=k[t],i=e.source;let o=0;i.height<f&&(o+=f-i.height);let s=null,r={},h=0;e.colorReplacements&&(s=e.colorReplacements);for(let t=M;t<x;t++){const e=i.frames[t];if(e){for(let t=0;t<i.layers.length;t++){v.globalCompositeOperation="source-over";const a=i.layers[t];if(!a.visible)continue;const c=e.layerData[a.id];if(c){a.mode&&(v.globalCompositeOperation=a.mode),a.opacity&&a.opacity<100?v.globalAlpha=a.opacity/100:v.globalAlpha=1;for(let t=0;t<c.length;t++){const e=c[t];r[e.x+h+":"+e.y]=!0;const i=e.x*n+R,a=(e.y+o)*n;let u=e.c;if(l&&"#ff00ff"==u&&(u=l),s)for(let t=0;t<s.length;t++){const e=s[t].c,n=s[t].r;if(u==e){u=n;break}}v.fillStyle=u,v.fillRect(i,a,n,n)}}}h+=a.width,R+=p}}if(v.globalCompositeOperation="source-over",c)for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++){const i=t*n,o=e*n;v.drawImage(c,i,o,n,n)}if(u){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=y.width,t.height=y.height,e.drawImage(y,0,0),v.fillStyle=u,v.globalCompositeOperation="source-over",v.globalAlpha=1;for(let t in r){const e=t.split(":"),i=parseInt(e[0]),o=parseInt(e[1]);for(let t=i-1;t<=i+1;t++)for(let e=o-1;e<=o+1;e++){const i=t*n,o=e*n;v.fillRect(i,o,n,n)}}v.drawImage(t,0,0)}}if(d<1){const t=document.createElement("canvas"),e=t.getContext("2d");t.height=m,t.width=w,e.drawImage(y,0,0),y.height=m,y.width=w,v.globalAlpha=d,v.drawImage(t,0,0)}if(t.asVPP)return void function(t,e,n){const s=e.getImageData(0,0,t.width,t.height),a=s.data;let l=0;const r={author:null,size:0,id:i(),voxels:[],precompiledat:null,vars:{created_timestamp:(new Date).getTime(),last_edit_timestamp:(new Date).getTime(),last_edit_app:null}};r.size=s.width,s.height>s.width&&(r.size=s.height),l=Math.floor(r.size/2);for(let t=0;t<a.length;t+=4){const e=Math.floor(t/4),n=Math.floor(e/s.width),i=e-n*s.width,c=a[t+0],h=a[t+1],u=a[t+2],d=a[t+3];if(0==d)continue;const f=o(c,h,u);let g={x:i-l,y:0,z:s.height-n-1,c:f,op:d/255};r.voxels.push(g)}n(r)}(y,v,e);if(t.asCanvas)return e?void e(y):y;const b=y.toDataURL();if(t.asDataURL)return e?void e(b):b;if(!e)return void console.log("Missing callback");const z=new Image;z.onload=function(){e(z)},z.src=b};window.addEventListener("resize",(function(){T()}));const d=2*Math.PI,f=320,g=300,m=1e3/30;let p={},w={},y=null,v=0;function M(t){const e=new x(t);if(p[e.id]=e,t.holders)for(const n of t.holders)e.addCamera(n.element,n.tag);return e}class x{constructor(t){this.id=i(),this.options=t,this.backgroundColor="black",this.ground=null,this.sky=null,this.undersky=null,this.oversky=null,this.track=null,this.tileReference={},this.tileMap=null,this.tileSize=8,this.minTileZ=0,this.maxTileZ=0,this.cameras=[],this.sprites=[],this.loopFunction=t.onLoop||null}destroy(){delete p[this.id];for(const t of this.cameras)t.holder.innerHTML=""}addCamera(t,e){const n=new R(t,e);return this.cameras.push(n),n}setOversky(t){const e=this;if(e.oversky=null,!t)return void(e.oversky=null);const n=_(t,null);e.oversky=n.name}setUndersky(t){const e=this;if(!t)return e.undersky=null,void(e.backgroundColor="black");const n=_(t,null);e.undersky=n.name}setSky(t){const e=this;if(e.sky=null,!t)return void(e.sky=null);const n=_(t,null);e.sky=n.name}setGround(t,e=null){const n=this;if(n.ground=null,!t)return void(n.ground=null);const i=_(t,e);n.ground=i.name}setTrack(t){const e=this;if(e.track=null,!t)return void(e.track=null);const n=_(t,null);e.track=n.name}setTile(t){if(Array.isArray(t))for(const e of t)U(this,e.x,e.y,e.z,e.id);else{if(null==t)return void(this.tileMap=null);U(this,t.x,t.y,t.z,t.id)}if(this.minTileZ=0,this.maxTileZ=0,this.tileMap){const t=this;this.tileMap.forEach((function(e,n){const i=n.split(":");if(3!=i.length)return;const o=parseInt(i[2]);o<t.minTileZ&&(t.minTileZ=o),o>t.maxTileZ&&(t.maxTileZ=o)}))}}setTileReference(t){if(Array.isArray(t))for(const e of t)j(this,e.id,e.src,e.colorReplacements);else{if(null==t)return void(this.tileReference={});j(this,t.id,t.src,t.colorReplacements)}}addSprite(t){t.instance||(t.instance=this);const e=new k(t);return this.sprites.push(e),e}clearSprites(){this.sprites=[]}}class R{constructor(t,e){this.id=i(),this.holder=t,this.tag=e,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d",{willReadFrequently:!0}),this.canvas.style.width="100%",this.canvas.style.height="100%",t.appendChild(this.canvas),this.x=84,this.y=142,this.z=16,this.width=f,this.height=240,this.angle=0,this.camScale=1,this.scaleX=g,this.scaleY=g,this.horizonDivider=3,this.horizon=Math.floor(this.height/this.horizonDivider),I(this)}setAngle(t){const e=t/360;this.angle=e*d,this.angle<0&&(this.angle+=d),this.angle>d&&(this.angle-=d)}setResolution(t){this.width=t,I(this)}}class k{constructor(t){this.x=t.x||0,this.y=t.y||0,this.z=t.z||0,this.options=t,this.scaleX=t.scaleX||t.scale||.16,this.scaleY=t.scaleY||t.scale||.16;const e=_(t.src,t.colorReplacements||[],t.autoFrame||!0);null!=t.directional&&(e.directional=t.directional),this.frame=-1,this.texture=e.name,this.instance=t.instance||null}remove(){if(this.instance){const t=this.instance.sprites.indexOf(this);-1!=t&&this.instance.sprites.splice(t,1)}}}class b{constructor(t){this.url=t.url,this.id=i(),this.frames=t.frames||1,this.images=[],this.loaded=!1,this.colorReplacements=t.colorReplacements||[],this.height=0,this.width=0,this.onLoad=t.onLoad||null,this.currentFrame=0,this.autoFrame=t.autoFrame||!0,this.name=P(this.url,this.colorReplacements,this.autoFrame),this.directional=t.directional||!1,function(t){if("object"==typeof t.url&&t.url.createdApp&&"Pixel Paint"==t.url.createdApp)return void A(t);if(t.url.toLowerCase().startsWith("<?xml"))return void S(t);if(t.url.toLowerCase().endsWith(".ppp"))return void A(t);if(t.url.toLowerCase().endsWith(".svg"))return void S(t);const e=new Image;e.onload=function(){t.autoFrame&&(t.frames=Math.floor(e.width/e.height)),C(t,e)},e.src=t.url}(this)}getCurrentFrame(t){if(this.directional){const t=this.images.length/8;this.frames!=t&&(this.frames=t,this.currentFrame=0)}let e=this.currentFrame;if(this.directional){let n=t.angle;n<0&&(n+=d);const i=n/d;e+=8*Math.floor(i*this.frames)}return this.images[e]}}class z{constructor(t,e){this.canvas=t,this.data=e}}function S(t){const e=[];if(t.colorReplacements&&t.colorReplacements.length>0)for(let n=0;n<t.colorReplacements.length;n++){const i=t.colorReplacements[n],o=i.c,s=i.r;e.push({from:o,to:s})}(function(t,e=[]){return new Promise((function(i,o){const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="document",s.onload=function(){const t=s.responseXML;let o=(new XMLSerializer).serializeToString(t);for(const t of e)o=n(o,"fill:"+t.from+";","fill:"+t.to+";"),o=n(o,"stroke:"+t.from+";","stroke:"+t.to+";");const a=new Blob([o],{type:"image/svg+xml"}),l=window.URL.createObjectURL(a),r=new Image;r.crossOrigin="anonymous",r.onload=function(){window.URL.revokeObjectURL(a),i(r)},r.src=l},s.onerror=function(){o()},s.send()}))})(t.url,e).then((function(e){t.autoFrame&&(t.frames=Math.floor(e.width/e.height)),C(t,e)}))}function A(t){u({source:t.url,frame:-1,scale:1,colorReplacements:t.colorReplacements,callback:function(e){t.frames=Math.floor(e.width/e.height),C(t,e)}})}function C(t,e){const n=document.createElement("canvas"),i=n.getContext("2d");n.width=e.width,n.height=e.height,i.drawImage(e,0,0);const o=Math.floor(e.width/t.frames);t.width=o,t.height=e.height;for(let i=0;i<t.frames;i++){const s=document.createElement("canvas"),a=s.getContext("2d");s.style.imageRendering="pixelated",a.imageSmoothingEnabled=!1,s.width=o,s.height=e.height,a.drawImage(n,o*i,0,o,e.height,0,0,o,e.height);const l=a.getImageData(0,0,o,e.height);t.images.push(new z(s,l))}t.loaded=!0,t.onLoad&&(t.onLoad(t),t.onLoad=null)}function T(){for(const t in p)F(p[t])}function F(t){for(const e of t.cameras)I(e)}function I(t){const e=t.holder,n=e.offsetWidth,i=e.offsetHeight,o=t.width/n,s=Math.floor(i*o);t.height=s,t.canvas.width=t.width,t.canvas.height=t.height,t.canvas.style.imageRendering="pixelated",t.context.imageSmoothingEnabled=!1,t.horizon=Math.floor(t.height/t.horizonDivider),t.camScale=t.width/f,t.scaleX=Math.round(g*t.camScale),t.scaleY=Math.round(g*t.camScale)}function L(t){for(const e of t.cameras)D(t,e)}function D(t,e){e.context.fillStyle=t.backgroundColor,e.context.fillRect(0,0,e.width,e.height);const n=e.horizon+1,i=e.angle/d;t.undersky&&O(e,t.undersky,n,i,!1),t.sky&&O(e,t.sky,n,i,!0),t.oversky&&O(e,t.oversky,n,i,!1);const o=e.context.getImageData(0,0,e.width,e.height),s=Math.cos(e.angle),a=Math.sin(e.angle);!function(t,e,n,i,o,s){let a=null,l=null,r=null;t.track&&(l=t.track,l&&l.loaded&&(r=l.images[l.currentFrame].data)),t.ground&&(a=w[t.ground]);for(let c=s+1;c<e.height;c++){const h=e.z*e.scaleY/(c-s),u=-o*(h/e.scaleX),d=i*(h/e.scaleY);let f=e.x+i*h-e.width/2*u,g=e.y+o*h-e.height/2*d;for(let i=0;i<e.width;i++){const e=Math.floor(f),o=Math.floor(g);let s=!1;if(r&&e>=0&&o>=0&&e<l.width&&o<l.height){const t=E(r,e,o);X(n,i,c,t),255==t.a&&(s=!0)}if(t.tileMap){const a=Math.floor(e/t.tileSize),l=Math.floor(o/t.tileSize);for(let r=t.maxTileZ;r>=t.minTileZ;r--){const h=Z(t,a,l,r);if(h){const a=t.tileReference[h];if(a){const l=w[a];l&&l.loaded&&(s=q(t,l,n,e,o,i,c))}}if(s)break}}a&&a.loaded&&!s&&q(t,a,n,e,o,i,c),f+=u,g+=d}}}(t,e,o,s,a,e.horizon),function(t,e,n,i,o){for(const s of t.sprites){if(!s.texture)continue;const t=w[s.texture];if(!t||!t.loaded)continue;let a=t.getCurrentFrame(e);-1!=s.frame&&s.frame<t.frames&&(a=s.frame);const l=s.x-e.x,r=s.y-e.y,c=l*i+r*o,h=r*i-l*o,u=t.width,d=t.height,f=Math.floor(u*e.scaleX/c*s.scaleX),g=Math.floor(d*e.scaleY/c*s.scaleY);if(f<1||g<1)continue;const m=Math.floor(e.scaleX/c*h+e.width/2),p=Math.floor(e.z*e.scaleY/c+e.horizon);let y=0;0!=s.z&&(y=s.z*e.scaleY/c);const v=Math.floor(m-f/2),M=Math.floor(p-g-y);v+f<0||v>e.width||M+g<0||M>e.height||Y(e,n,t,a,v,M,f,g)}}(t,e,o,s,a),e.context.putImageData(o,0,0)}function O(t,e,n,i,o){const s=w[e];if(!s||!s.loaded)return;const a=s.images[s.currentFrame].canvas;let l=Math.round(s.height*t.camScale),r=Math.round(s.width*t.camScale);if(o&&r<1.25*t.width){r=Math.round(1.25*t.width);const e=r/s.width;l=Math.round(s.height*e)}let c=0-Math.round(r*i),h=n-l,u=!1;for(;!u;)t.context.drawImage(a,c,h,r,l),c+r<t.width?c+=r:u=!0}function E(t,e,n){const i=4*(Math.floor(Math.abs(n))*t.width+Math.floor(Math.abs(e)));return{r:t.data[i],g:t.data[i+1],b:t.data[i+2],a:t.data[i+3]}}function X(t,e,n,i){const o=4*(n*t.width+e);t.data[o]=i.r,t.data[o+1]=i.g,t.data[o+2]=i.b,t.data[o+3]=i.a}function P(t,e,n=!1){let i=a(t);if("object"==typeof i&&i.createdApp&&"Pixel Paint"==i.createdApp&&(i=a(JSON.stringify(i))),e&&e.length>0)for(let t=0;t<e.length;t++){const n=e[t];i+="."+n.c+":"+n.r}return n&&(i+=".af"),i}function Y(t,e,n,i,o,s,a,l){const r=n.images[i].data;for(let i=s;i<s+l;i++)if(!(i<0||i>=t.height))for(let c=o;c<o+a;c++){if(c<0||c>=t.width)continue;const h=Math.floor((c-o)/a*n.width),u=4*(Math.floor((i-s)/l*n.height)*n.width+h),d=r.data[u],f=r.data[u+1],g=r.data[u+2],m=r.data[u+3];if(255==m){const t=4*(i*e.width+c);e.data[t]=d,e.data[t+1]=f,e.data[t+2]=g,e.data[t+3]=m}}}function Z(t,e,n,i){return t.tileMap.get(N(e,n,i))}function N(t,e,n){return Math.floor(t)+":"+Math.floor(e)+":"+Math.floor(n)}function U(t,e,n,i,o){t.tileMap||(t.tileMap=new Map),t.tileMap.set(N(e,n,i),o)}function j(t,e,n,i){t.tileReference||(t.tileReference={});const o=_(n,i);t.tileReference[e]=o.name}function _(t,e,n=!1){const i=P(t,e,n);return w[i]||(w[i]=new b({url:t,colorReplacements:e,autoFrame:n})),w[i]}function q(t,e,n,i,o,s,a){const l=e.width/t.tileSize,r=e.height/t.tileSize;let c=i%t.tileSize*l,h=o%t.tileSize*r;c<0&&(c+=e.width),h<0&&(h+=e.height);const u=E(e.images[e.currentFrame].data,c,h);return X(n,s,a,u),255==u.a}requestAnimationFrame((function t(e){null==y&&(y=e);const n=e-y;y=e;let i=n/m;const o=1e3/n;isNaN(i)&&(i=1);for(const t in p){const e=p[t];L(e),e.loopFunction&&e.loopFunction(i,o)}!function(t){for(v+=t;v>=5;){v-=5;for(const t in w){const e=w[t];e.frames<=1||e.loaded&&(e.currentFrame++,e.currentFrame>=e.frames&&(e.currentFrame=0))}}}(i),requestAnimationFrame(t)}));const J={getInstance:M,getTexture:_,getTextureName:P};var W=e.Ay,H=e.iE,V=e.Mc,G=e.XL,$=e.mU;export{W as default,H as getInstance,V as getTexture,G as getTextureName,$ as resizeAllInstances};